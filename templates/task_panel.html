{% extends "base.html" %}
{% block head %}
    <link rel="stylesheet" href="/static/task_panel.css">
{% endblock %}
{% block body %}
{% if access == "accountant" or access == "admin" %}
    {% if approval_status.accountant in [None, 0, 1035] %}

        <div class="select-container" id="select-container-accountant">
            <div id="select-container-accountant-div">
                <div class="form-floating">
                    <select id="accountant" class="form-select">
                        <option value="1031">Согласован без замечаний</option>
                        <option value="1033">Согласован с замечаниями</option>
                        <option value="1035">Несогласован</option>
                    </select>
                    <label for="accountant">Бухгалтера</label>
                </div>
                <div class="form-floating">
                    <textarea class="form-control" id="comment-accountant" rows="3" style="height: 130px;"></textarea>
                    <label for="comment-accountant">Комментарий</label>
                </div>
                <button type="button" class="btn" id="button-accountant">ПОДТВЕРДИТЬ</button>
            </div>
        </div>
    {% elif approval_status.accountant not in [None, 0, 1035] and approval_status.lawyer in [None, 0, 1041] %}
        <h1>Договор согласован бухгалтером</h1>
    {% endif %}
{% endif %}
{% if access == "lawyer" or access == "admin" %}

    {% if approval_status.lawyer in [None, 0, 1041] %}

        <div class="select-container" id="select-container-lawyer">
            <div class="form-floating">
                <select id="lawyer" class="form-select">
                    <option value="1037">Согласован без замечаний</option>
                    <option value="1039">Согласован с замечаниями</option>
                    <option value="1041">Несогласован</option>
                </select>
                <label for="lawyer">Юристы</label>
            </div>
            <div class="form-floating">
                <textarea class="form-control" id="comment-lawyer" rows="3" style="height: 130px;"></textarea>
                <label for="comment-lawyer">Комментарий</label>
            </div>
            <button type="button" class="btn" id="button-lawyer">ПОДТВЕРДИТЬ</button>
        </div>
    {% elif approval_status.lawyer not in [None, 0, 1041] and approval_status.accountant not in [None, 0, 1035] and attached_file == False%}
        <div id="file-lawyer" class="mb-3">
            <label for="formFileMultiple" class="form-label">Прикрепите согласованный договор</label>
            <input class="form-control" type="file" id="formFileMultiple" multiple>
            <button type="button" class="btn" id="button-lawyer-send-file">ОТПРАВИТЬ</button>
        </div>
    {% else %}
        <h1>Договор согласован и прикреплен к элементу</h1>
    {% endif %}
{% endif %}
{% endblock %}
{% block footer %}
    <script>
    const select_container_accountant = document.getElementById('select-container-accountant');
    const select_container_accountant_div = document.getElementById('select-container-accountant-div');
    const select_container_lawyer = document.getElementById('select-container-lawyer');
    const button_accountant = document.querySelector('#button-accountant');
    const button_lawyer = document.querySelector('#button-lawyer');
    const button_lawyer_file = document.querySelector('#button-lawyer-send-file');
    const file_lawyer = document.getElementById('file-lawyer');
    if (button_accountant) {
        button_accountant.addEventListener('click', function () {
            var select_option_accountant = document.getElementById('accountant');
            var comment_accountant = document.getElementById('comment-accountant');
            BX24.init(function () {
                BX24.callMethod('crm.item.update', {
                    'entityTypeId': 131,
                    'id': "{{ element_id }}",
                    'fields': {
                        'ufCrm12_1709191865371': select_option_accountant.value,
                        'ufCrm12_1709702893': "{{ user_id }}",
                        'ufCrm12_1708599567866': comment_accountant.value
                    }
                });
                BX24.callMethod('im.message.add', {
                    'DIALOG_ID': "{{ responsible }}",
                    'MESSAGE': "[SIZE=18][B]✔️Договор согласован Бухгалтером по задаче: [URL=https://sporbita.bitrix24.ru/company/personal/user/77297/tasks/task/view/{{ task_id }}/]{{ task_id }}[/URL][/B][/SIZE]"
                });
            });
            console.log(select_option_accountant.value)
            if (select_option_accountant.value === "1031") {
                document.body.style.background = '#cffcd2';
            } else if (select_option_accountant.value === "1033") {
                document.body.style.background = '#ffcd38';
            } else if (select_option_accountant.value === "1035") {
                document.body.style.background = '#fd4343';
            }
            select_container_accountant_div.style.display = 'none';
        });
    }
    if (button_lawyer) {
        button_lawyer.addEventListener('click', function () {
            var select_option_lawyer = document.getElementById('lawyer');
            var comment_lawyer = document.getElementById('comment-lawyer');
            BX24.init(function () {
                BX24.callMethod('crm.item.update', {
                    'entityTypeId': 131,
                    'id': "{{ element_id }}",
                    'fields': {
                        'ufCrm12_1709192259979': select_option_lawyer.value,
                        'ufCrm12_1709702831': "{{ user_id }}",
                        'ufCrm12_1708093511140': comment_lawyer.value
                    }
                });
                BX24.callMethod('im.message.add', {
                    'DIALOG_ID': "{{ accomplices }}",
                    'MESSAGE': "[SIZE=18][B]✔️Договор согласован Юристом по задаче: [URL=https://sporbita.bitrix24.ru/company/personal/user/77297/tasks/task/view/{{ task_id }}/]{{ task_id }}[/URL][/B][/SIZE]",
                });
            });
            console.log(select_option_lawyer.value)
            if (select_option_lawyer.value === "1037") {
                document.body.style.background = '#cffcd2';
            } else if (select_option_lawyer.value === "1039") {
                document.body.style.background = '#ffcd38';
            } else if (select_option_lawyer.value === "1041") {
                document.body.style.background = '#fd4343';
            }
            select_container_lawyer.style.display = 'none';
        });
    }

    if (button_lawyer_file) {
        {#button_lawyer_file.addEventListener('click', function () {#}
        {#    const file = document.getElementById('formFileMultiple').files[0];#}
        {#    const list_file = [];#}
        {#    if (file) {#}
        {#        const reader = new FileReader();#}
        {#        reader.onload = (event) => BX24.init(function () {#}
        {#            BX24.callMethod('crm.item.update', {#}
        {#                'entityTypeId': 131,#}
        {#                'id': "{{ element_id }}",#}
        {#                'fields': {#}
        {#                    'ufCrm12_1712146917716': [#}
        {#                        [file.name, String(event.target.result.split(',')[1])],#}
        {#                    ],#}
        {#                }#}
        {#            });#}
        {#            BX24.callMethod('im.message.add', {#}
        {#                'DIALOG_ID': "{{ accomplices }}",#}
        {#                'MESSAGE': "[SIZE=18][B]✔️Договор согласован и прикреплен к элементу: [URL=https://sporbita.bitrix24.ru/company/personal/user/77297/tasks/task/view/{{ task_id }}/]{{ task_id }}[/URL][/B][/SIZE]"#}
        {#            });#}
        {#        });#}
        {#        reader.readAsDataURL(file);#}
        {#        file_lawyer.style.display = 'none';} else {alert('Прикрепите договор!');}});#}
        button_lawyer_file.addEventListener('click', function () {
            const files = document.getElementById('formFileMultiple').files;
            if (files) {
                const list_file = [];
                for (let i = 0; i < files.length; i++) {
                    if (files[i]) {
                        const reader = new FileReader();
                        reader.onload = (event) => list_file.push([files[i].name, String(event.target.result.split(',')[1])])
                        reader.readAsDataURL(files[i]);
                    }
                }
                BX24.init(function () {
                    BX24.callMethod('crm.item.update', {
                        'entityTypeId': 131,
                        'id': "{{ element_id }}",
                        'fields': {
                            'ufCrm12_1712146917716': list_file,
                        }
                    });
                    BX24.callMethod('im.message.add', {
                        'DIALOG_ID': "{{ accomplices }}",
                        'MESSAGE': "[SIZE=18][B]✔️Договор согласован и прикреплен к элементу: [URL=https://sporbita.bitrix24.ru/company/personal/user/77297/tasks/task/view/{{ task_id }}/]{{ task_id }}[/URL][/B][/SIZE]"
                    });
                });
                file_lawyer.style.display = 'none';
            } else {
                alert('Прикрепите договор!');
            }

        });
    }
    </script>
    <script src="/static/task_panel.js"></script>
{% endblock %}